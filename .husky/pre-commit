#!/usr/bin/env bash

echo "ğŸ” Storing uncommitted changes..."
STASH_NAME="pre-commit-$(date +%s)"
# Check both tracked and untracked files, excluding .git directory
if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
  git stash push -q --include-untracked --keep-index -m "$STASH_NAME" -- ':!:.git/*'
fi

# define a function to restore the stash
restore_and_exit() {
  local exit_code=$1
  echo "â™»ï¸  Restoring stashed changes..."
  if [ -n "$(git stash list | grep "$STASH_NAME")" ]; then
    git stash pop -q
  fi
  exit $exit_code
}

# trap Ctrl+C and any script exit
trap 'restore_and_exit $?' EXIT
trap 'echo ""; echo "âš ï¸  Interrupt detected..."' INT

echo "ğŸš€ Running pre-commit checks..."

echo ""; echo "ğŸ”§ Running TypeScript check..."
yarn type-check || { echo "âŒ TypeScript check failed"; exit 1; }

echo ""; echo "ğŸ’„ Checking code formatting..."
yarn prettier:check || { echo "âŒ Prettier check failed"; exit 1; }

echo ""; echo "ğŸ” Running linter..."
yarn lint || { echo "âŒ Linter check failed"; exit 1; }

echo ""; echo "ğŸ§ª Running tests..."
yarn test || { echo "âŒ Tests failed"; exit 1; }

echo ""; echo "ğŸ—ï¸  Checking build..."
yarn build || { echo "âŒ Build check failed"; exit 1; }

echo ""; echo "âœ… All checks passed"
exit 0
